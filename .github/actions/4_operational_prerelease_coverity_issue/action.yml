name: 'Create Coverity Scan Issue'
description: 'Creates a GitHub issue for Coverity scan'
inputs:
  release:
    description: 'Release version (e.g., 4.7.1)'
    required: true
  stage:
    description: 'Stage (e.g., RC 3, Alpha 1)'
    required: true
  main_issue:
    description: 'Main issue number'
    required: true
  prev_issue:
    description: 'Previous issue number'
    required: true
  assignee:
    description: 'GitHub username to assign the issue to'
    required: true
  github_token:
    description: 'GitHub token'
    required: true
outputs:
  issue_url:
    description: 'URL of the created issue'
    value: ${{ steps.create-issue.outputs.issue_url }}
runs:
  using: 'composite'
  steps:
    - name: Create Coverity Scan Issue
      id: create-issue
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        RELEASE="${{ inputs.release }}"
        STAGE="${{ inputs.stage }}"
        MAIN_ISSUE="${{ inputs.main_issue }}"
        PREV_ISSUE="${{ inputs.prev_issue }}"

        REPO="wazuh/wazuh"
        LABEL="level/task,type/test,type/test/coverity"
        TITLE="Release $RELEASE - $STAGE - Coverity scan"
        TAG="v$RELEASE-$(echo ${STAGE// /} | tr '[:upper:]' '[:lower:]')"

        BODY=$(cat <<EOF
        |Main RC issue|Version|Stage|Tag|Previous issue|
        |---|---|---|---|---|
        |#$MAIN_ISSUE|$RELEASE|$STAGE|[$TAG](https://github.com/wazuh/wazuh/tree/$TAG)|#$PREV_ISSUE|

        This issue will show the results of the Coverity scan for the current RC.
        - [Coverity dashboard](https://scan.coverity.com/projects/wazuh-wazuh)

        ## Auditors' validation
        - [ ] @wazuh/devel-xdrsiem-agent
        - [ ] @wazuh/devel-xdrsiem-qa-release
        EOF
        )

        ISSUE_URL=$(gh issue create \
          --repo "$REPO" \
          --title "$TITLE" \
          --label "$LABEL" \
          --assignee "${{ inputs.assignee }}" \
          --body "$BODY")

        echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
