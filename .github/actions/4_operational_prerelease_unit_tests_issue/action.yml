name: 'Create Unit Tests Issue'
description: 'Creates a GitHub issue for C Unit tests and RTR'
inputs:
  release:
    description: 'Release version (e.g., 4.7.1)'
    required: true
  stage:
    description: 'Stage (e.g., RC 3, Alpha 1)'
    required: true
  main_issue:
    description: 'Main issue number'
    required: true
  prev_issue:
    description: 'Previous issue number'
    required: true
  assignee:
    description: 'GitHub username to assign the issue to'
    required: true
  github_token:
    description: 'GitHub token'
    required: true
outputs:
  issue_url:
    description: 'URL of the created issue'
    value: ${{ steps.create-issue.outputs.issue_url }}
runs:
  using: 'composite'
  steps:
    - name: Create Unit Tests Issue
      id: create-issue
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        RELEASE="${{ inputs.release }}"
        STAGE="${{ inputs.stage }}"
        MAIN_ISSUE="${{ inputs.main_issue }}"
        PREV_ISSUE="${{ inputs.prev_issue }}"

        REPO="wazuh/wazuh"
        LABEL="level/task,type/test"
        TITLE="Release $RELEASE - $STAGE - C Unit tests and RTR"
        TAG="v$RELEASE-$(echo ${STAGE// /} | tr '[:upper:]' '[:lower:]')"

        BODY=$(cat <<EOF
        |Main RC issue|Version|Stage|Tag|Previous issue|
        |---|---|---|---|---|
        |#$MAIN_ISSUE|$RELEASE|$STAGE|[$TAG](https://github.com/wazuh/wazuh/tree/$TAG)|#$PREV_ISSUE|

        This issue aims to run all C unit tests and RTR checks for the current stage and report the results. Any failing test should be properly addressed with a new issue, detailing the error and the possible cause. Then, it will be determined if that failure is to be fixed immediately or marked as expected if there is enough support and approval. In case a test is marked as expected-fail, the issue detailing the error should always be used as a reference in the test.

        > [!NOTE]
        > These tests are run locally.

        ## Auditors' validation

        In order to close and proceed with the release or the next candidate version, the following auditors must give the green light to this RC.

        - [ ] @wazuh/devel-xdrsiem-agent
        - [ ] @wazuh/devel-xdrsiem-qa-release
        EOF
        )

        ISSUE_URL=$(gh issue create \
          --repo "$REPO" \
          --title "$TITLE" \
          --label "$LABEL" \
          --assignee "${{ inputs.assignee }}" \
          --body "$BODY")

        echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
